<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Profil Saya</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<!-- PROTEKSI -->
<script>
if (
  localStorage.getItem("login") !== "true" ||
  localStorage.getItem("alumni_status") !== "Verified"
) {
  window.location.href = "../index.html";
}
</script>

<nav class="navbar bg-white shadow-sm">
  <div class="container">
    <span class="navbar-brand fw-bold">Profil Saya</span>
    <a href="../index.html" class="btn btn-secondary btn-sm">Kembali</a>
  </div>
</nav>

<div class="container mt-4">

<div class="row">

<div class="col-md-4">

  <img
    id="fotoProfil"
    src="https://www.w3schools.com/howto/img_avatar.png"
    width="140"
    class="rounded-circle mb-3">
    <h5 id="nama" class="mt-2"></h5>
    <p id="email" class="text-muted"></p>

  <a
    href="https://drive.google.com/drive/folders/1FZmh5Jf8OorZAE9H_4EflMbfj6kQHzPW"
    target="_blank"
    class="btn btn-warning w-100 mb-2">

    Upload Foto ke Google Drive
  </a>

  <input
    type="text"
    id="linkFoto"
    class="form-control"
    placeholder="Tempel link foto Google Drive">

  <button
    class="btn btn-success w-100 mt-2"
    onclick="simpanFoto()">

    Simpan Foto Profil
  </button>

</div>


<!-- ================= DATA ALUMNI ================= -->
<div class="col-md-8">
  <div class="card shadow">
    <div class="card-header fw-bold">Data Alumni</div>
    <div class="card-body">
      <p><b>Program Studi:</b> <span id="program"></span></p>
      <p><b>Tahun Lulus:</b> <span id="tahun"></span></p>

      <small class="text-muted">
        ðŸ”’ Data akademik bersifat resmi dan tidak dapat diubah oleh alumni.
      </small>
    </div>
  </div>
</div>

</div>

<!-- ================= KARIER ================= -->
<div class="card shadow mt-4">
  <div class="card-header fw-bold">
    Status Karier Alumni
  </div>

  <div class="card-body">

    <div class="mb-3">
      <label class="form-label">Status Karier</label>
      <select id="statusKarier" class="form-select" onchange="toggleKarier()">
        <option value="">-- Pilih --</option>
        <option value="Bekerja">Bekerja</option>
        <option value="Belum Bekerja">Belum Bekerja</option>
      </select>
    </div>

    <div id="formBekerja" style="display:none;">
      <input id="jabatan" class="form-control mb-2" placeholder="Jabatan">
      <input id="perusahaan" class="form-control mb-2" placeholder="Perusahaan">
      <input id="linkedin" class="form-control mb-2" placeholder="LinkedIn">
      <input id="instagram" class="form-control mb-2" placeholder="Instagram">

      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="hubungi">
        <label class="form-check-label">
          Saya bersedia dihubungi
        </label>
      </div>
    </div>

    <button class="btn btn-success" onclick="simpanKarier()">
      Simpan Status Karier
    </button>

  </div>
</div>

</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbyDS1ml_xKj_1BAvS6_eD9sMbbYDShc3IFUtONn4jV117sDkHgr1TkxhjFm-DF1FqjAVw/exec";

async function loadProfil() {
  const email = localStorage.getItem("email");

  const res = await fetch(API + "?action=getAlumni&email=" + encodeURIComponent(email));
  const data = await res.json();

  // âœ… PROTEKSI
  if (!data || data.status === "not_found") return;

  document.getElementById("nama").innerText = data.nama || "-";
  document.getElementById("email").innerText = data.email || "-";
  document.getElementById("program").innerText = data.program_studi || "-";
  document.getElementById("tahun").innerText = data.tahun || "-";

  let foto = data.foto;

// default avatar
if (!foto || foto === "-" || foto === "undefined") {
  foto = "https://www.w3schools.com/howto/img_avatar.png";
}

// kalau link Drive â†’ ubah ke format image
if (foto.includes("drive.google.com")) {
  const match = foto.match(/\/d\/(.+?)\//);
  if (match) {
    foto = "https://drive.google.com/uc?id=" + match[1];
  }
}

document.getElementById("fotoProfil").src =
  foto + "&t=" + Date.now();
}

function toggleKarier() {
  document.getElementById("formBekerja").style.display =
    statusKarier.value === "Bekerja" ? "block" : "none";
}

async function simpanKarier() {
  const fd = new FormData();
  fd.append("action", "updateKarier");
  fd.append("email", localStorage.getItem("email"));
  fd.append("status_karier", statusKarier.value);
  fd.append("jabatan", jabatan.value);
  fd.append("perusahaan", perusahaan.value);
  fd.append("linkedin", linkedin.value);
  fd.append("instagram", instagram.value);
  fd.append("hubungi", hubungi.checked ? "Ya" : "Tidak");

  await fetch(API, { method: "POST", body: fd });
  alert("Status karier berhasil disimpan");
}

function convertDriveLink(link) {
  const match = link.match(/\/d\/(.+?)\//);
  if (!match) return null;
  return "https://drive.google.com/uc?id=" + match[1];
}

async function simpanFoto() {
  const link = document.getElementById("linkFoto").value.trim();
  if (!link) return alert("Tempel link foto dulu");

  const finalLink = convertDriveLink(link);
  if (!finalLink) return alert("Link Google Drive tidak valid");

  const fd = new FormData();
  fd.append("action", "updateAlumni");
  fd.append("email", localStorage.getItem("email"));
  fd.append("foto", finalLink);

  await fetch(API, { method: "POST", body: fd });

  document.getElementById("fotoProfil").src =
    finalLink + "&t=" + Date.now();

  alert("âœ… Foto profil berhasil disimpan");
}

loadProfil();
</script>

</body>
</html>
